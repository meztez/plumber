<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programmatic Usage • plumber</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Programmatic Usage">
<meta property="og:description" content="plumber">
<meta property="og:image" content="https://www.rplumber.io/logo.svg">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plumber</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.0.0.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/quickstart.html">Quickstart</a>
    </li>
    <li>
      <a href="../articles/routing-and-input.html">Routing &amp; Input</a>
    </li>
    <li>
      <a href="../articles/rendering-output.html">Rendering Output</a>
    </li>
    <li>
      <a href="../articles/execution-model.html">Runtime</a>
    </li>
    <li>
      <a href="../articles/security.html">Security</a>
    </li>
    <li>
      <a href="../articles/hosting.html">Hosting</a>
    </li>
    <li>
      <a href="../articles/programmatic-usage.html">Programmatic Usage</a>
    </li>
    <li>
      <a href="../articles/annotations.html">Annotations reference</a>
    </li>
    <li>
      <a href="../articles/tips-and-tricks.html">Tips &amp; Tricks</a>
    </li>
    <li>
      <a href="../articles/migration.html">Migration Guide</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/plumber/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="programmatic-usage_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Programmatic Usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/plumber/blob/master/vignettes/programmatic-usage.Rmd"><code>vignettes/programmatic-usage.Rmd</code></a></small>
      <div class="hidden name"><code>programmatic-usage.Rmd</code></div>

    </div>

    
    
<p>Typically, users define APIs using the “annotations,” or special comments in their API source code. It is possible to define a Plumber API programmatically using the same underlying R6 objects that get created automatically when you define your API using annotations. Interacting with Plumber at this level can offer more control and specificity about how you want your API to behave.</p>
<div id="creating-and-controlling-a-router" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-and-controlling-a-router" class="anchor"></a>Creating and Controlling a Router</h2>
<p>The centerpiece of Plumber is the router. Plumber routers are responsible for coordinating incoming requests from httpuv, dispatching the requests to the appropriate filters/endpoints, serializing the response, and handling errors that might pop up along the way. If you’ve been using annotations to define Plumber APIs, then you’ve already worked with Plumber routers as that’s what the <code><a href="../reference/plumb.html">plumb()</a></code> command produces.</p>
<p>To instantiate a new Plumber router programmatically, you can call <code><a href="../reference/pr.html">pr()</a></code>. This will return a blank Plumber router with no endpoints. You could call <code><a href="../reference/pr_run.html">pr_run()</a></code> on the returned object to start the API, but it doesn’t know how to respond to any requests so any incoming traffic would get a <code>404</code> response. We’ll see momentarily how to add endpoints and filters onto this empty router. Alternatively, you can pass a file that contains your annotation-based Plumber API as the first parameter to create a router much like you do with <code><a href="../reference/plumb.html">plumb()</a></code>.</p>
<p>Be aware that Plumber routers do come with a handful of filters pre-configured. These built-in filters are used to do things like process properties of the incoming request like its cookies, <code>POST</code> body, or query string. You can specify which filters you want in your new router by overriding the <code>filters</code> parameter when creating your new router.</p>
</div>
<div id="defining-endpoints" class="section level2">
<h2 class="hasAnchor">
<a href="#defining-endpoints" class="anchor"></a>Defining Endpoints</h2>
<p>You can define endpoints on your router by using the <code><a href="../reference/pr_handle.html">pr_handle()</a></code>, <code><a href="../reference/pr_handle.html">pr_get()</a></code>, or <code><a href="../reference/pr_handle.html">pr_post()</a></code>. For instance, to define a Plumber API that response to <code>GET</code> requests on <code><a href="https://rdrr.io/r/base/Arithmetic.html">/</a></code> and <code>POST</code> requests on <code>/submit</code>, you could use the following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">{</span>
    <span class="co"># ...</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_handle.html">pr_post</a></span><span class="op">(</span><span class="st">"/submit"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">{</span>
    <span class="co"># ...</span>
  <span class="op">}</span><span class="op">)</span></pre></div>
<p>The “handler” functions that you define in these calls are identical to the code you would have defined in your <code>plumber.R</code> file if you were using annotations to define your API.</p>
<p>The route methods take additional arguments that allow you to control nuanced behavior of the endpoint like which filter it might preempt or which serializer it should use. For instance, the following endpoint would use Plumber’s HTML serializer.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
    <span class="st">"&lt;html&gt;&lt;h1&gt;Programmatic Plumber!&lt;/h1&gt;&lt;/html&gt;"</span>
  <span class="op">}</span>, serializer <span class="op">=</span> <span class="fu">plumber</span><span class="fu">::</span><span class="fu"><a href="../reference/serializer_headers.html">serializer_html</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
<div id="defining-filters" class="section level2">
<h2 class="hasAnchor">
<a href="#defining-filters" class="anchor"></a>Defining Filters</h2>
<p>Use the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> method of a Plumber router to define a new filter:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_filter.html">pr_filter</a></span><span class="op">(</span><span class="st">"myFilter"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">{</span>
    <span class="va">req</span><span class="op">$</span><span class="va">filtered</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
    <span class="fu"><a href="../reference/forward.html">forward</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Am I filtered?"</span>, <span class="va">req</span><span class="op">$</span><span class="va">filtered</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span></pre></div>
<p>You can specify other options such as the serializer to use if the filter returns a value in the <code><a href="../reference/pr_filter.html">pr_filter()</a></code> method, as well.</p>
</div>
<div id="router-hooks" class="section level2">
<h2 class="hasAnchor">
<a href="#router-hooks" class="anchor"></a>Registering Hooks on a Router</h2>
<p>Plumber routers support the notion of “hooks” that can be registered to execute some code at a particular point in the lifecycle of a request. Plumber routers currently support four hooks:</p>
<ul>
<li><code>preroute(data, req, res)</code></li>
<li><code>postroute(data, req, res, value)</code></li>
<li><code>preserialize(data, req, res, value)</code></li>
<li><code>postserialize(data, req, res, value)</code></li>
</ul>
<p>In all of the above you have access to a disposable environment in the <code>data</code> parameter that is created as a temporary data store for each request. Hooks can store temporary data in these hooks that can be reused by other hooks processing this same request.</p>
<p>One feature when defining hooks in Plumber routers is the ability to modify the returned value. The convention for such hooks is: any function that accepts a parameter named <code>value</code> is expected to return the new value. This could be an unmodified version of the value that was passed in, or it could be a mutated value. But in either case, if your hook accepts a parameter named <code>value</code>, whatever your hook returns will be used as the new value for the response.</p>
<p>You can add hooks using the <code>pr_hook</code> method, or you can add multiple hooks at once using the <code>pr_hooks</code> method which takes a name list in which the names are the names of the hooks, and the values are the handlers themselves.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_hook.html">pr_hook</a></span><span class="op">(</span><span class="st">"preroute"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Routing a request for"</span>, <span class="va">req</span><span class="op">$</span><span class="va">PATH_INFO</span>, <span class="st">"...\n"</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_hook.html">pr_hooks</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    preserialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">value</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"About to serialize this value:"</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>

      <span class="co"># Must return the value since we took one in. Here we're not choosing</span>
      <span class="co"># to mutate it, but we could.</span>
      <span class="va">value</span>
    <span class="op">}</span>,
    postserialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"We serialized the value as:"</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">body</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_handle.html">pr_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span> <span class="fl">123</span> <span class="op">}</span><span class="op">)</span></pre></div>
<p>Making a <code>GET</code> request to <code><a href="https://rdrr.io/r/base/Arithmetic.html">/</a></code> will print out various information from the three events for which we registered hooks.</p>
</div>
<div id="mount-static" class="section level2">
<h2 class="hasAnchor">
<a href="#mount-static" class="anchor"></a>Mounting &amp; Static File Routers</h2>
<p>Plumber routers can be “nested” by mounting one into another using the <code>mount()</code> method. This allows you to compartmentalize your API by paths which is a great technique for decomposing large APIs into smaller files.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">users</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="st">"users.R"</span><span class="op">)</span>
<span class="va">products</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="st">"products.R"</span><span class="op">)</span>

<span class="va">root</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_mount.html">pr_mount</a></span><span class="op">(</span><span class="st">"/users"</span>, <span class="va">users</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_mount.html">pr_mount</a></span><span class="op">(</span><span class="st">"/products"</span>, <span class="va">products</span><span class="op">)</span>

<span class="va">root</span></pre></div>
<p>This is the same approach used for defining routers that serve a directory of static files. Static file routers are just a special case of Plumber routers created using <code><a href="../reference/pr_static.html">pr_static()</a></code>. For example</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="../reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_static.html">pr_static</a></span><span class="op">(</span><span class="st">"/assets"</span>, <span class="st">"./myfiles"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pr_run.html">pr_run</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<p>This will make the files and directories stored in the <code>./myfiles</code> directory available on your API under the <code>/assets/</code> path.</p>
</div>
<div id="customize-router" class="section level2">
<h2 class="hasAnchor">
<a href="#customize-router" class="anchor"></a>Customizing a Router</h2>
<p>There are a handful of useful methods to be aware of to modify the behavior of a router. <a href="#router-hooks">Using hooks to alter request processing</a> has already been discussed, but additionally you can modify a router’s behavior using any of the following:</p>
<ul>
<li>
<code><a href="../reference/pr_set_serializer.html">pr_set_serializer()</a></code> - Sets the default serializer of the router.</li>
<li>
<code><a href="../reference/pr_set_error.html">pr_set_error()</a></code> - Sets the error handler which gets invoked if any filter or endpoint generates an error.</li>
<li>
<code><a href="../reference/pr_set_404.html">pr_set_404()</a></code> - Sets the handler that gets called if an incoming request can’t be served by any filter, endpoint, or sub-router.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://schloerke.com/">Barret Schloerke</a>, <a href="https://trestletech.com/">Jeff Allen</a>,  RStudio.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '',
    indexName: '',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
